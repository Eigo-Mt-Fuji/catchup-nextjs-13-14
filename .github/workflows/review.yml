name: run
on:
  pull_request:
jobs:
  review_for_me:
    runs-on: ubuntu-latest
    environment: default
    strategy:
      matrix:
        node-version: ['21.x']
    steps:

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Use node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - name: Review
      env:
        OPENAI_API_KEY: ${{secrets.OPENAI_API_KEY}}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        INTERNAL_API_KEY: ${{secrets.API_KEY}}
      run: |
        cd ./scripts/reviewer/
        echo $OPENAI_API_KEY
        npm install
        npm run build
        git diff --diff-filter=d  --name-only origin/${{ github.base_ref }}..HEAD ../../src | grep -e '\.tsx$' -e '\.ts$' | while read file; do
          git diff origin/${{ github.base_ref }}..HEAD "../../${file}"
          review_result=$(git diff origin/${{ github.base_ref }}..HEAD "../../${file}" | OPENAI_API_KEY="$OPENAI_API_KEY" npm run start ../../${file})
          echo "{\"comment\":\"$review_result\"}" > history_body.json
          curl -XPOST -H "Content-Type: application/json" -H "x-api-key: $INTERNAL_API_KEY" https://www.efgriver.com/internal/reviewer/history -d@history_body.json > history_response.json
          cat history_response.json
          export HISTORY_ID=$(cat history_response.json | jq -rc ".id")
          export EVAL_ACTION_MD_SNIPPET="<a href=\"#\" onclick=\"fetch('https://www.efgriver.com/internal/reviewer/feedback?id=$HISTORY_ID',{method:'POST'});\"><img src=\"https://www.efgriver.com/good.svg\" width=\"30\" alt=\"Good\" /></a>"
          gh pr comment ${{ github.event.pull_request.number }} --body "${review_result}<br/> $EVAL_ACTION_MD_SNIPPET"
        done
